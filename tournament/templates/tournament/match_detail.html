{% extends 'tournament/base.html' %}
{% load static %}
{% load math_filters %}

{% block content %}
<div class="container mt-4">
    <!-- Match Header -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h2>{{ match.home_team.name }} vs {{ match.away_team.name }}</h2>
            <h5>{{ match.date|date:"F j, Y H:i" }} at {{ match.venue }}</h5>
            <span class="badge bg-{% if match.is_live %}danger{% elif match.status == 'COMPLETED' %}success{% else %}info{% endif %}">
                {% if match.is_live %}LIVE{% elif match.status == 'COMPLETED' %}COMPLETED{% else %}UPCOMING{% endif %}
            </span>
            {% if match.status == 'COMPLETED' %}
                <h4>
                    {% if match.winner %}
                        {{ match.winner.name }} won by 
                        {% if match.result == 'Home Win' or match.result == 'Away Win' %}
                            {{ match.home_score|subtract:match.away_score|abs }} runs
                        {% else %}
                            {{ 10|subtract:match.total_wickets }} wickets
                        {% endif %}
                    {% else %}
                        Match Tied
                    {% endif %}
                </h4>
                {% if match.man_of_the_match %}
                    <h5>Player of the Match: {{ match.man_of_the_match.name }}</h5>
                {% endif %}
            {% endif %}
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h4>Match Summary</h4>
                    <p><strong>Toss:</strong> {{ match.toss_winner.name }} chose to {{ match.toss_decision }}</p>
                    {% if match.status == 'COMPLETED' %}
                        <p><strong>Result:</strong> {{ match.result }}</p>
                    {% endif %}
                </div>
                <div class="col-md-6">
                    {% if match.is_live %}
                        <h4>Current Status</h4>
                        <p><strong>Innings:</strong> {{ match.innings }}</p>
                        <p><strong>Score:</strong> 
                            {{ match.batting_team.name }}: {{ match.total_runs }}/{{ match.total_wickets }} 
                            ({{ match.current_over }}.{{ match.current_ball }})
                            {% if match.innings == 2 %}
                                - Target: {{ target|default:0 }}
                            {% endif %}
                        </p>
                        <p><strong>CRR:</strong> {{ match.current_run_rate|floatformat:2 }}</p>
                        {% if match.innings == 2 %}
                            <p><strong>RRR:</strong> {{ match.required_run_rate|floatformat:2 }}</p>
                        {% endif %}
                        
                        <!-- Current Players -->
                        <div class="mt-3">
                            <h5>Current Players</h5>
                            <p>
                                <strong>Batting:</strong> 
                                {{ match.striker.name }}* ({{ match.striker_runs }}) 
                                & {{ match.non_striker.name }} ({{ match.non_striker_runs }})
                            </p>
                            <p>
                                <strong>Bowling:</strong> 
                                {{ match.bowler.name }} ({{ match.bowler_runs }}/{{ match.bowler_wickets }})
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Scorecard Navigation -->
    <ul class="nav nav-tabs" id="scorecardTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="batting-tab" data-bs-toggle="tab" 
                    data-bs-target="#batting" type="button" role="tab">
                Batting
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="bowling-tab" data-bs-toggle="tab" 
                    data-bs-target="#bowling" type="button" role="tab">
                Bowling
            </button>
        </li>
    </ul>

    <!-- Scorecard Content -->
    <div class="tab-content" id="scorecardContent">
        <!-- Batting Tab -->
        <div class="tab-pane fade show active" id="batting" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header">
                    <ul class="nav nav-tabs" id="battingInningsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" 
                                    id="batting-innings1-tab" data-bs-toggle="tab" 
                                    data-bs-target="#batting-innings1" type="button" role="tab">
                                1st Innings - {{ first_innings_team.name }}
                            </button>
                        </li>
                        {% if second_innings_batting %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    id="batting-innings2-tab" data-bs-toggle="tab" 
                                    data-bs-target="#batting-innings2" type="button" role="tab">
                                2nd Innings - {{ second_innings_team.name }}
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="battingInningsContent">
                        <!-- 1st Innings Batting -->
                        <div class="tab-pane fade show active" 
                             id="batting-innings1" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Batsman</th>
                                            <th>R</th>
                                            <th>B</th>
                                            <th>4s</th>
                                            <th>6s</th>
                                            <th>SR</th>
                                            <th>Out</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for performance in first_innings_batting %}
                                        <tr class="{% if not performance.not_out %}table-danger{% endif %}">
                                            <td>
                                                {{ performance.player.name }}
                                                {% if not performance.not_out %}
                                                    <small class="text-muted">
                                                        {% if performance.wicket_type == 'bowled' %}
                                                            b {{ performance.bowler.name }}
                                                        {% elif performance.wicket_type == 'caught' %}
                                                            c {{ performance.fielder.name }} b {{ performance.bowler.name }}
                                                        {% elif performance.wicket_type == 'lbw' %}
                                                            lbw b {{ performance.bowler.name }}
                                                        {% elif performance.wicket_type == 'run_out' %}
                                                            run out ({{ performance.fielder.name }})
                                                        {% elif performance.wicket_type == 'stumped' %}
                                                            st {{ performance.fielder.name }} b {{ performance.bowler.name }}
                                                        {% else %}
                                                            out
                                                        {% endif %}
                                                    </small>
                                                {% endif %}
                                            </td>
                                            <td>{{ performance.runs }}</td>
                                            <td>{{ performance.balls_faced }}</td>
                                            <td>{{ performance.fours }}</td>
                                            <td>{{ performance.sixes }}</td>
                                            <td>{{ performance.strike_rate|floatformat:2 }}</td>
                                            <td>{% if not performance.not_out %}Yes{% else %}No{% endif %}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-info">
                                            <td><strong>Total</strong></td>
                                            <td>{{ first_innings_total.runs__sum|default:0 }}</td>
                                            <td>{{ first_innings_total.balls_faced__sum|default:0 }}</td>
                                            <td>{{ first_innings_total.fours__sum|default:0 }}</td>
                                            <td>{{ first_innings_total.sixes__sum|default:0 }}</td>
                                            <td></td>
                                            <td>{{ first_innings_wickets }} wickets</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>

                        <!-- 2nd Innings Batting -->
                        {% if second_innings_batting %}
                        <div class="tab-pane fade" 
                             id="batting-innings2" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Batsman</th>
                                            <th>R</th>
                                            <th>B</th>
                                            <th>4s</th>
                                            <th>6s</th>
                                            <th>SR</th>
                                            <th>Out</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for performance in second_innings_batting %}
                                        <tr class="{% if not performance.not_out %}table-danger{% endif %}">
                                            <td>
                                                {{ performance.player.name }}
                                                {% if not performance.not_out %}
                                                    <small class="text-muted">
                                                        {% if performance.wicket_type == 'bowled' %}
                                                            b {{ performance.bowler.name }}
                                                        {% elif performance.wicket_type == 'caught' %}
                                                            c {{ performance.fielder.name }} b {{ performance.bowler.name }}
                                                        {% elif performance.wicket_type == 'lbw' %}
                                                            lbw b {{ performance.bowler.name }}
                                                        {% elif performance.wicket_type == 'run_out' %}
                                                            run out ({{ performance.fielder.name }})
                                                        {% elif performance.wicket_type == 'stumped' %}
                                                            st {{ performance.fielder.name }} b {{ performance.bowler.name }}
                                                        {% else %}
                                                            out
                                                        {% endif %}
                                                    </small>
                                                {% endif %}
                                            </td>
                                            <td>{{ performance.runs }}</td>
                                            <td>{{ performance.balls_faced }}</td>
                                            <td>{{ performance.fours }}</td>
                                            <td>{{ performance.sixes }}</td>
                                            <td>{{ performance.strike_rate|floatformat:2 }}</td>
                                            <td>{% if not performance.not_out %}Yes{% else %}No{% endif %}</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                    <tfoot>
                                        <tr class="table-info">
                                            <td><strong>Total</strong></td>
                                            <td>{{ second_innings_total.runs__sum|default:0 }}</td>
                                            <td>{{ second_innings_total.balls_faced__sum|default:0 }}</td>
                                            <td>{{ second_innings_total.fours__sum|default:0 }}</td>
                                            <td>{{ second_innings_total.sixes__sum|default:0 }}</td>
                                            <td></td>
                                            <td>{{ second_innings_wickets }} wickets</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Bowling Tab -->
        <div class="tab-pane fade" id="bowling" role="tabpanel">
            <div class="card mt-3">
                <div class="card-header">
                    <ul class="nav nav-tabs" id="bowlingInningsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" 
                                    id="bowling-innings1-tab" data-bs-toggle="tab" 
                                    data-bs-target="#bowling-innings1" type="button" role="tab">
                                1st Innings - {{ first_innings_bowling_team.name }}
                            </button>
                        </li>
                        {% if second_innings_bowling %}
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" 
                                    id="bowling-innings2-tab" data-bs-toggle="tab" 
                                    data-bs-target="#bowling-innings2" type="button" role="tab">
                                2nd Innings - {{ second_innings_bowling_team.name }}
                            </button>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="bowlingInningsContent">
                        <!-- 1st Innings Bowling -->
                        <div class="tab-pane fade show active" 
                             id="bowling-innings1" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Bowler</th>
                                            <th>O</th>
                                            <th>M</th>
                                            <th>R</th>
                                            <th>W</th>
                                            <th>Econ</th>
                                            <th>Extras</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for performance in first_innings_bowling %}
                                        <tr>
                                            <td>{{ performance.player.name }}</td>
                                            <td>{{ performance.overs|floatformat:1 }}</td>
                                            <td>{{ performance.maidens }}</td>
                                            <td>{{ performance.runs_conceded }}</td>
                                            <td>{{ performance.wickets }}</td>
                                            <td>{{ performance.economy|floatformat:2 }}</td>
                                            <td>
                                                {% if performance.wides > 0 %}Wd:{{ performance.wides }}{% endif %}
                                                {% if performance.no_balls > 0 %}Nb:{{ performance.no_balls }}{% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- 2nd Innings Bowling -->
                        {% if second_innings_bowling %}
                        <div class="tab-pane fade" 
                             id="bowling-innings2" role="tabpanel">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Bowler</th>
                                            <th>O</th>
                                            <th>M</th>
                                            <th>R</th>
                                            <th>W</th>
                                            <th>Econ</th>
                                            <th>Extras</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for performance in second_innings_bowling %}
                                        <tr>
                                            <td>{{ performance.player.name }}</td>
                                            <td>{{ performance.overs|floatformat:1 }}</td>
                                            <td>{{ performance.maidens }}</td>
                                            <td>{{ performance.runs_conceded }}</td>
                                            <td>{{ performance.wickets }}</td>
                                            <td>{{ performance.economy|floatformat:2 }}</td>
                                            <td>
                                                {% if performance.wides > 0 %}Wd:{{ performance.wides }}{% endif %}
                                                {% if performance.no_balls > 0 %}Nb:{{ performance.no_balls }}{% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Controls -->
{% if user.is_superuser %}
<div class="mt-4 text-center">
    {% if can_set_live %}
        <!-- Button to set match live (for upcoming matches) -->
        <a href="{% url 'set_match_live' match.id %}" class="btn btn-lg btn-success">
            <i class="fas fa-play"></i> Set Match Live
        </a>
    {% elif can_start_match %}
        <!-- Button to start match (after setting live but before first innings) -->
        <a href="{% url 'initialize_match_players' match.id %}" class="btn btn-lg btn-primary">
            <i class="fas fa-play"></i> Start Match
        </a>
    {% elif match.is_live %}
        <!-- Button to update live score (already exists in your code) -->
        <a href="{% url 'update_score' match.id %}" class="btn btn-lg btn-danger">
            <i class="fas fa-edit"></i> Update Live Score
        </a>
    {% endif %}
</div>
{% endif %}
</div>

<style>
    .table-responsive {
        overflow-x: auto;
    }
    .nav-tabs .nav-link {
        font-weight: 500;
    }
    .table th {
        white-space: nowrap;
    }
    .badge {
        font-size: 0.8rem;
    }
    .table-danger {
        background-color: rgba(220, 53, 69, 0.1);
    }
    .table-info {
        background-color: rgba(13, 202, 240, 0.1);
    }
</style>

<script>
    // Initialize Bootstrap tabs
    document.addEventListener('DOMContentLoaded', function() {
        var firstTab = document.getElementById('batting-tab');
        if (firstTab) {
            var tab = new bootstrap.Tab(firstTab);
            tab.show();
        }
    });
</script>
{% endblock %}